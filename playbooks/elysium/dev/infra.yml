- name: Create private network
  hosts: localhost
  connection: local
  vars_files:
    - vars/hetzner.yml
  gather_facts: false

  tasks:
    - name: Create SSH key
      hetzner.hcloud.ssh_key:
        name: elysium-dev
        public_key: "{{ ssh_key }}"

    - name: Create network
      hetzner.hcloud.network:
        name: private
        ip_range: 10.0.0.0/16
        state: present

    # - name: Create subnets
    #   hetzner.hcloud.subnetwork:
    #     network: private
    #     ip_range: "{{ item }}"
    #     network_zone: eu-central
    #     type: server
    #     state: present
    #   loop:
    #     - 10.0.0.0/24

    - name: Create placement group
      hetzner.hcloud.placement_group:
        name: elysium-dev
        type: spread
        state: present

    - name: Create server
      hetzner.hcloud.server:
        name: elysium-dev
        image: ubuntu-22.04
        server_type: cax41
        ssh_keys:
          - elysium-dev
        placement_group: elysium-dev
        state: present
        user_data: |
          #cloud-config
          package_update: true
          packages:
            - curl

          users:
            - name: ansible
              sudo: ALL=(ALL) NOPASSWD:ALL
              ssh_authorized_keys:
                - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCV3CGG5V5iii6/KhRiFAie60f22IWTFvLoLWQztsDrVHxK68KhoxGnfIfDjI7iqj19HqaCCeCY/Sp/j/eZfpqC+/v/6xk6IQQXFZdx0LYG4Z0rsxwoBvCrxoXHcmU+tBEfoFZdKvhqBG+eoSxQOx5S1vtjENaDViln2cj4zpNpE/RkSoOLYC7aNoQwmIcr4G+yrzpCRWyCHdNAnq6qIy3EyWh/dibRrdp1F/1PH8NU12FvFgb+SmCt5CkN2MmMXNRnqW7P61PElVKwOA2jrg4JXub9o3Skd5BcCwxX7/uASvc49icp4EyC5/7wM9SeTGcvBqYFNP8kRdfXo0uPlsam8ecsXnpO0hHAkUe/67ovrt8JApEGngs+MuVWlFB/UCiWWooYLlX1CAQGNJMcyUDuT6TckxShErqPF2xRDCFoLBzH1TOYXKvNtRhw1/7CallylifbseQWq5FIUViaqcY4V8eEFxeDjDbmQA8R8vp7FN6TI1z8AlAkagXdhSFMpIM= alessandro@DESKTOP-CQI0QDA

    - name: Create DNS entry for elysium-dev
      community.dns.hetzner_dns_record:
        zone_name: spoletum.net
        record: '@'
        type: A
        value: "{{ elysium_dev.hcloud_server.ipv4_address }}"
        state: present
        hetzner_token: "{{ lookup('env', 'HCLOUD_DNS_TOKEN') }}"
