- name: Create private network
  hosts: localhost
  connection: local
  gather_facts: false

  tasks:
    - name: Create SSH key
      hetzner.hcloud.ssh_key:
        name: elysium-dev
        public_key: "{{ ssh_key }}"

    - name: Create network
      hetzner.hcloud.network:
        name: private
        ip_range: 10.0.0.0/16
        state: present

    # - name: Create subnets
    #   hetzner.hcloud.subnetwork:
    #     network: private
    #     ip_range: "{{ item }}"
    #     network_zone: eu-central
    #     type: server
    #     state: present
    #   loop:
    #     - 10.0.0.0/24

    - name: Create placement group
      hetzner.hcloud.placement_group:
        name: elysium-dev
        type: spread
        state: present

    - name: Create server
      hetzner.hcloud.server:
        name: elysium-dev
        image: ubuntu-22.04
        server_type: cax41
        ssh_keys:
          - elysium-dev
        placement_group: elysium-dev
        state: present
      register: elysium_dev
        # private_networks:
        #   - private

    - name: Write the Ansible inventory file
      ansible.builtin.template:
        src: templates/inventory.ini.j2
        dest: ../../../inventories/inventory.ini
        mode: '0600'
      delegate_to: localhost

    - name: Create DNS entry for elysium-dev
      community.dns.hetzner_dns_record:
        zone_name: spoletum.net
        name: '*'
        type: A
        value: "{{ elysium_dev.hcloud_server.ipv4_address }}"
        state: present
        hetzner_token: "{{ lookup('env', 'HCLOUD_DNS_TOKEN') }}"
